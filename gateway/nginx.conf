worker_processes 1;

events {
    worker_connections 1024;
}

http {
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;
    sendfile      on;
    keepalive_timeout 65;

    upstream auth_service {
        server auth-service:8001;
    }

    upstream product_service { server product-service:8002; }
    upstream customer_service { server customer-service:8003; }
    upstream cart_service { server cart-service:8004; }
    upstream order_service { server order-service:8005; }
    upstream notification_service { server notification-service:8006; }
    upstream make_order_service { server make-order-service:8007; }

    server {
        listen 8000;
        server_name _;
        root /usr/share/nginx/html;
        index index.html;

        # Health check
        location /health {
            return 200 "ok";
        }

        # Auth service routes
        location /auth/ {
            proxy_pass http://auth_service/auth/;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header Authorization $http_authorization;
        }

        # Product service routes
        location /products {
            proxy_pass http://product_service/products;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header Authorization $http_authorization;
        }

        # Customer service routes (must be before cart to avoid conflict)
        location ~ ^/customers/[^/]+/cart {
            proxy_pass http://cart_service;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header Authorization $http_authorization;
        }

        location /customers/ {
            proxy_pass http://customer_service/customers/;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }

        # Order service routes
        location /orders {
            proxy_pass http://order_service/orders;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header Authorization $http_authorization;
        }

        # Notification service routes
        location /notifications/ {
            proxy_pass http://notification_service/notifications/;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }

        # Make-Order service routes
        location /ordering {
            proxy_pass http://make_order_service;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }

        # Default fallback: serve frontend
        location / {
            try_files $uri $uri/ /index.html;
        }
    }
}
